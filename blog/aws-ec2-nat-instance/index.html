<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>profile | Creating a NAT instance on Amazon Linux 2 using Packer and Ansible.</title>
  <meta name="description" content="">

  
  
    <meta property="og:image" content="https://example.com/img/profile.png" />
    <meta property="og:title" content="profile | Creating a NAT instance on Amazon Linux 2 using Packer and Ansible." />   
  
  <meta property="og:description" content="" />
  <meta name="author" content="h neco">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900&display=swap"></noscript>
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
      <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&display=swap"></noscript>
  <link rel="preload" href="https://use.fontawesome.com/releases/v5.12.1/css/all.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.1/css/all.css"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css" integrity="sha512-JW3fT0YTK7pT7w437SoX6GcW76jOZ6E0jGmrqBAcloC4GKT+njHOY4fX5KxJ9WfIXTkNrAF994525fAHp+KCxg==" crossorigin="anonymous" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css" integrity="sha512-JW3fT0YTK7pT7w437SoX6GcW76jOZ6E0jGmrqBAcloC4GKT+njHOY4fX5KxJ9WfIXTkNrAF994525fAHp+KCxg==" crossorigin="anonymous"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css" integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin="anonymous" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css" integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin="anonymous"></noscript>
  
  <link rel="preload" href="https://example.com/css/resume.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://example.com/css/resume.css"></noscript>
  <link rel="preload" href="https://example.com/css/tweaks.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://example.com/css/tweaks.css"></noscript>
  <link rel="preload" href="https://example.com/css/resume-override.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://example.com/css/resume-override.css"></noscript>
  <meta name="generator" content="Hugo 0.111.3">
  
   
  
</head>
<body id="page-top">
  <nav class="navbar navbar-expand-lg navbar-dark bg-profile fixed-top" id="sideNav">
  <a class="navbar-brand js-scroll-trigger" href="#page-top">
    <span class="d-block d-lg-none">h neco</span>
    <span class="d-none d-lg-block">
      <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="/img/profile.png" alt="">
    </span>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#about">About</a>
      </li>
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#skills">Skills</a>
          </li>
      
      
      
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#experience">Experience</a>
          </li>
      
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#blog">Blog</a>
          </li>
      
    </ul>
  </div>
</nav>

  <div class="container-fluid p-0">
    
<nav aria-label="breadcrumb">
  <ol  class="breadcrumb">
    





<li class="breadcrumb-item">
  <a href="https://example.com/">Home</a>
</li>


<li class="breadcrumb-item">
  <a href="https://example.com/blog/">Blog</a>
</li>


<li class="breadcrumb-item active">
  <a href="https://example.com/blog/aws-ec2-nat-instance/">Creating a NAT instance on Amazon Linux 2 using Packer and Ansible.</a>
</li>

  </ol>
</nav>




<section class="resume-section p-3 p-lg-5 d-flex flex-column">
  <div class="my-auto">
  	<div class="mb-3 d-flex flex-row justify-content-between">
    	<h2 class="mb-0"><span class="text-primary">Creating a NAT instance on Amazon Linux 2 using Packer and Ansible.</span></h2>
    	<span class="">April 11, 2023</span>
    </div>
    <div>
    	<h2 id="intro">Intro</h2>
<p>I have set up a NAT instance using amazonLinux2. I utilized Packer and Ansible for the configuration process.</p>
<ul>
<li>Set up a NAT instance using amazonLinux2.
<ul>
<li>Explain why amazonLinux2 is chosen:
<ul>
<li>Lambda does not support incoming connections initiated externally, so it does not support FTP in active mode.</li>
<li>ECS does not allow for the static allocation of private IP addresses.
<ul>
<li>While it is possible to achieve static allocation by combining it with NAT Private Gateway, since it is a gateway type, it cannot accept incoming connections from external sources.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="technical-elements">Technical Elements</h2>
<ul>
<li>Packer</li>
<li>Ansible
<ul>
<li>iptables
<ul>
<li>In CentOS7 (amazonLinux2), the default firewall management system is firewalld. However, I will introduce iptables to set up the NAT instance.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="file-structure">File Structure</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>$ tree .
</span></span><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── ansible.cfg
</span></span><span style="display:flex;"><span>├── bin
</span></span><span style="display:flex;"><span>│   └── init.sh
</span></span><span style="display:flex;"><span>├── inventory
</span></span><span style="display:flex;"><span>│   └── hosts
</span></span><span style="display:flex;"><span>├── packer-template
</span></span><span style="display:flex;"><span>│   └── nat_instance.json
</span></span><span style="display:flex;"><span>├── playbook
</span></span><span style="display:flex;"><span>│   └── setup.yml
</span></span><span style="display:flex;"><span>└── roles
</span></span><span style="display:flex;"><span>    └── iptable
</span></span><span style="display:flex;"><span>        └── tasks
</span></span><span style="display:flex;"><span>            ├── main.yml
</span></span><span style="display:flex;"><span>            └── templates
</span></span><span style="display:flex;"><span>                ├── iptables-config.j2
</span></span><span style="display:flex;"><span>                ├── nat_cidr.j2
</span></span><span style="display:flex;"><span>                └── sysctl.conf
</span></span></code></pre></div><h2 id="executing-packer-and-template-files">Executing Packer and Template Files</h2>
<ul>
<li>Execution Command
<ul>
<li>packer build packer-template/nat_instance.json</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>└── packer-template
</span></span><span style="display:flex;"><span>   └── nat_instance.json
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;variables&#34;</span>: <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;aws_access_key&#34;</span>: <span style="color:#e6db74">&#34;{{env `AWS_ACCESS_KEY`}}&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;aws_secret_key&#34;</span>: <span style="color:#e6db74">&#34;{{env `AWS_SECRET_KEY`}}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;builders&#34;</span>: [
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;amazon-ebs&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;access_key&#34;</span>: <span style="color:#e6db74">&#34;{{user `aws_access_key`}}&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;secret_key&#34;</span>: <span style="color:#e6db74">&#34;{{user `aws_secret_key`}}&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;region&#34;</span>: <span style="color:#e6db74">&#34;ap-northeast-1&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ami_regions&#34;</span>: [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ap-northeast-1&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;associate_public_ip_address&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;source_ami&#34;</span>: <span style="color:#e6db74">&#34;ami-0a3d21ec6281df8cb&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;instance_type&#34;</span>: <span style="color:#e6db74">&#34;t3.micro&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ssh_username&#34;</span>: <span style="color:#e6db74">&#34;ec2-user&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ami_name&#34;</span>: <span style="color:#e6db74">&#34;nat-{{timestamp}}&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;tags&#34;</span>: <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;Name&#34;</span>: <span style="color:#e6db74">&#34;nat-instance&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">}</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;ena_support&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;enable_t2_unlimited&#34;</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">}</span>
</span></span><span style="display:flex;"><span>    ],
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;provisioners&#34;</span>: [
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;shell&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;script&#34;</span>: <span style="color:#e6db74">&#34;./bin/init.sh&#34;</span>,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;pause_before&#34;</span>: <span style="color:#e6db74">&#34;60s&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;ansible-local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;inventory_file&#34;</span>: <span style="color:#e6db74">&#34;inventory/hosts&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;playbook_file&#34;</span>: <span style="color:#e6db74">&#34;playbook/setup.yml&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;role_paths&#34;</span>: [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;roles/iptable&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;staging_directory&#34;</span>: <span style="color:#e6db74">&#34;/tmp/ansible-local&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;extra_arguments&#34;</span>: [<span style="color:#e6db74">&#34;-vv&#34;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">}</span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div><h2 id="preparing-ansible">Preparing Ansible</h2>
<ul>
<li>file Structure</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── ansible.cfg
</span></span><span style="display:flex;"><span>├── bin
</span></span><span style="display:flex;"><span>│   └── init.sh
</span></span><span style="display:flex;"><span>└── inventory
</span></span><span style="display:flex;"><span>   └── hosts
</span></span></code></pre></div><h2 id="install-ansible">Install ansible</h2>
<p>Ansible installation can be done by running <code>./bin/init.sh</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>sudo yum -y update
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ansible install</span>
</span></span><span style="display:flex;"><span>amazon-linux-extras install epel
</span></span><span style="display:flex;"><span>amazon-linux-extras enable ansible2
</span></span><span style="display:flex;"><span>amazon-linux-extras install ansible2
</span></span></code></pre></div><h2 id="configuration-of-the-inventory-file">Configuration of the inventory file</h2>
<p>Place the <code>inventory/hosts</code> file</p>
<p>Since I will be running Ansible locally from the server I set up, specify &ldquo;local&rdquo; as the target.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[default]
</span></span><span style="display:flex;"><span>127.0.0.1
</span></span></code></pre></div><h2 id="placing-the-configuration-file">Placing the configuration file</h2>
<p>Place the <code>ansible.cfg</code> file</p>
<p>This file is used for running Ansible. Below is the sample configuration:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>[defaults]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># Specify the Python interpreter
</span></span><span style="display:flex;"><span>interpreter_python=/usr/bin/python3
</span></span><span style="display:flex;"><span># Location of the hosts file
</span></span><span style="display:flex;"><span>inventory = inventroy/hosts
</span></span><span style="display:flex;"><span># Whether to validate host keys when connecting
</span></span><span style="display:flex;"><span>host_key_checking = True
</span></span><span style="display:flex;"><span># Number of parallel processes to use for remote connections
</span></span><span style="display:flex;"><span>forks=5
</span></span><span style="display:flex;"><span># Path to the log file
</span></span><span style="display:flex;"><span>log_path=~/logs/ansible/ansible.log
</span></span><span style="display:flex;"><span># Color settings
</span></span><span style="display:flex;"><span>nocolor=0
</span></span><span style="display:flex;"><span>scp_if_ssh=True
</span></span></code></pre></div><h2 id="creating-an-ansible-playbook">Creating an Ansible Playbook</h2>
<ul>
<li>file Structure</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>.
</span></span><span style="display:flex;"><span>├── playbook
</span></span><span style="display:flex;"><span>│   └── setup.yml
</span></span><span style="display:flex;"><span>└── roles
</span></span><span style="display:flex;"><span>    └── iptable
</span></span><span style="display:flex;"><span>        └── tasks
</span></span><span style="display:flex;"><span>            ├── main.yml
</span></span><span style="display:flex;"><span>            └── templates
</span></span><span style="display:flex;"><span>                ├── iptables-config.j2
</span></span><span style="display:flex;"><span>                ├── nat_cidr.j2
</span></span><span style="display:flex;"><span>                └── sysctl.conf
</span></span></code></pre></div><p>Writing playbook/setup.yml Invoked by Packer.I will be writing the playbook/setup.yml file that is invoked by Packer. I will call the iptables role and pass the chain that performs source address/port translation upon egress after routing.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- hosts: all
</span></span><span style="display:flex;"><span>  become: yes
</span></span><span style="display:flex;"><span>  become_user: root
</span></span><span style="display:flex;"><span>  remote_user: ec2-user
</span></span><span style="display:flex;"><span>  roles:
</span></span><span style="display:flex;"><span>    - role: iptable
</span></span><span style="display:flex;"><span>      vars:
</span></span><span style="display:flex;"><span>        nat_cidr: 10.0.0.1/24
</span></span></code></pre></div><p>I will also write the main.yml file for the iptables role that is invoked by the playbook. The main structure involves the installation of iptables and the configuration of the necessary configuration files.</p>
<ul>
<li>roles/iptable/tasks/main.yml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>- name: Install iptables-service
</span></span><span style="display:flex;"><span>  yum: name=iptables-services state=latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- name: Enable port forwarding
</span></span><span style="display:flex;"><span>  template: src=&#34;sysctl.conf&#34; dest=&#34;/etc/sysctl.conf&#34; owner=root group=root mode=0644
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># IP tables
</span></span><span style="display:flex;"><span>- name: Make iptables file
</span></span><span style="display:flex;"><span>  template: src=&#34;{{ item }}.j2&#34; dest=&#34;/etc/sysconfig/{{ item }}&#34; owner=root group=root mode=0600
</span></span><span style="display:flex;"><span>  with_items:
</span></span><span style="display:flex;"><span>    - &#34;nat_cidr&#34;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># IP tables config
</span></span><span style="display:flex;"><span>- name: Make iptables-config file
</span></span><span style="display:flex;"><span>  template: src=&#34;iptables-config.j2&#34; dest=&#34;/etc/sysconfig/iptables-config-nat&#34; owner=root group=root mode=0600
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- name: Install ftp command
</span></span><span style="display:flex;"><span>  yum: name=ftp state=latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- name: Install tcpdump command
</span></span><span style="display:flex;"><span>  yum: name=tcpdump state=latest
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>- name: Install lftp command
</span></span><span style="display:flex;"><span>  yum: name=lftp state=latest
</span></span></code></pre></div><ul>
<li>Writing the Template Files Used in the Above.We will proceed to write the template files used in the above instructions.
<ul>
<li>roles/iptable/tasks/templates/iptables-config.j2</li>
<li>roles/iptable/tasks/templates/sysctl.conf</li>
<li>roles/iptable/tasks/templates/nat_cidr.j2</li>
</ul>
</li>
</ul>
<p><code>roles/iptable/tasks/templates/iptables-config.j2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>IPTABLES_MODULES=&#34;nf_conntrack_ftp nf_nat_ftp&#34;
</span></span><span style="display:flex;"><span>IPTABLES_MODULES_UNLOAD=&#34;yes&#34;
</span></span><span style="display:flex;"><span>IPTABLES_SAVE_ON_STOP=&#34;no&#34;
</span></span><span style="display:flex;"><span>IPTABLES_SAVE_ON_RESTART=&#34;no&#34;
</span></span><span style="display:flex;"><span>IPTABLES_SAVE_COUNTER=&#34;no&#34;
</span></span><span style="display:flex;"><span>IPTABLES_STATUS_NUMERIC=&#34;yes&#34;
</span></span><span style="display:flex;"><span>IPTABLES_STATUS_VERBOSE=&#34;no&#34;
</span></span><span style="display:flex;"><span>IPTABLES_STATUS_LINENUMBERS=&#34;yes&#34;
</span></span></code></pre></div><p><code>roles/iptable/tasks/templates/sysctl.conf</code></p>
<p>To enable a feature called IPv4 forwarding, set the contents of the &ldquo;/proc/sys/net/ipv4/ip_forward&rdquo; file to &ldquo;1&rdquo;.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>net.ipv4.ip_forward=1
</span></span></code></pre></div><p><code>roles/iptable/tasks/templates/nat_cidr.j2</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>*filter
</span></span><span style="display:flex;"><span>:INPUT ACCEPT [0:0]
</span></span><span style="display:flex;"><span>:FORWARD ACCEPT [0:0]
</span></span><span style="display:flex;"><span>:OUTPUT ACCEPT [0:0]
</span></span><span style="display:flex;"><span>COMMIT
</span></span><span style="display:flex;"><span>*nat
</span></span><span style="display:flex;"><span>:POSTROUTING ACCEPT [0:0]
</span></span><span style="display:flex;"><span>-A POSTROUTING -s {{ nat_cidr }} -j MASQUERADE
</span></span><span style="display:flex;"><span>COMMIT
</span></span><span style="display:flex;"><span>*raw
</span></span><span style="display:flex;"><span>:PREROUTING ACCEPT [0:0]
</span></span><span style="display:flex;"><span>-A PREROUTING -p tcp --dport 21 -j CT --helper ftp
</span></span><span style="display:flex;"><span>COMMIT
</span></span></code></pre></div><h2 id="to-configure-the-network-settings-for-ec2">To configure the network settings for EC2</h2>
<p>Disable the destination check for the NAT instance&rsquo;s Elastic Network Interface (ENI) in your instance configuration.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>aws ec2 modify-instance-attribute \
</span></span><span style="display:flex;"><span>  --no-source-dest-check \
</span></span><span style="display:flex;"><span>  --instance-id ${INSTANCE_ID}
</span></span></code></pre></div><h2 id="to-connect-to-the-server-and-start-iptables">To connect to the server and start iptables</h2>
<p>To deploy the configuration file using Ansible and restart iptables</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># Overwrite the configuration file with the file distributed through Ansible
</span></span><span style="display:flex;"><span>sudo cp /etc/sysconfig/iptables-config-nat /etc/sysconfig/iptables
</span></span><span style="display:flex;"><span># Persist the configuration
</span></span><span style="display:flex;"><span>sudo service iptables save
</span></span><span style="display:flex;"><span># Restart the service
</span></span><span style="display:flex;"><span>sudo systemctl restart iptables
</span></span></code></pre></div>
	    
	</div>
    <div>
    	
    </div>
    <ul class="tags">
    
</ul>

  </div>
</section>

    <section><span style="color: #999999;">Nifty <a href="https://codepen.io/wbeeftink/pen/dIaDH">tech tag lists</a> from <a class="pen-owner-link" href="https://codepen.io/wbeeftink">Wouter Beeftink</a> </span>
      
    </section>
  </div>
  
  <script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js" integrity="sha512-0QbL0ph8Tc8g5bLhfVzSqxe9GERORsKhIn1IrpxDAgUsbBGz/V7iSav2zzW325XGd1OMLdL4UiqRJj702IeqnQ==" crossorigin="anonymous"></script>
  
  <script async src="/js/resume.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z6BYZ5M6VX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-Z6BYZ5M6VX');
  </script>
  

  
</body>
</html>
