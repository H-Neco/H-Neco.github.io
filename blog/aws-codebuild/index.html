<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>profile | codebuild構築とdeployフローの整備</title>
  <meta name="description" content="">

  
  
    <meta property="og:image" content="https://h-neco.github.io/img/profile.png" />
    <meta property="og:title" content="profile | codebuild構築とdeployフローの整備" />   
  
  <meta property="og:description" content="" />
  <meta name="author" content="h neco">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Saira+Extra+Condensed:100,200,300,400,500,600,700,800,900&display=swap"></noscript>
  <link rel="preload" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
      <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i,800,800i&display=swap"></noscript>
  <link rel="preload" href="https://use.fontawesome.com/releases/v5.12.1/css/all.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.1/css/all.css"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css" integrity="sha512-JW3fT0YTK7pT7w437SoX6GcW76jOZ6E0jGmrqBAcloC4GKT+njHOY4fX5KxJ9WfIXTkNrAF994525fAHp+KCxg==" crossorigin="anonymous" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/devicons/1.8.0/css/devicons.min.css" integrity="sha512-JW3fT0YTK7pT7w437SoX6GcW76jOZ6E0jGmrqBAcloC4GKT+njHOY4fX5KxJ9WfIXTkNrAF994525fAHp+KCxg==" crossorigin="anonymous"></noscript>
  <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css" integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin="anonymous" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simple-line-icons/2.5.5/css/simple-line-icons.min.css" integrity="sha512-QKC1UZ/ZHNgFzVKSAhV5v5j73eeL9EEN289eKAEFaAjgAiobVAnVv/AGuPbXsKl1dNoel3kNr6PYnSiTzVVBCw==" crossorigin="anonymous"></noscript>
  
  <link rel="preload" href="https://h-neco.github.io/css/resume.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://h-neco.github.io/css/resume.css"></noscript>
  <link rel="preload" href="https://h-neco.github.io/css/tweaks.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://h-neco.github.io/css/tweaks.css"></noscript>
  <link rel="preload" href="https://h-neco.github.io/css/resume-override.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://h-neco.github.io/css/resume-override.css"></noscript>
  <meta name="generator" content="Hugo 0.111.3">
  
   
  
</head>
<body id="page-top">
  <nav class="navbar navbar-expand-lg navbar-dark bg-profile fixed-top" id="sideNav">
  <a class="navbar-brand js-scroll-trigger" href="#page-top">
    <span class="d-block d-lg-none">h neco</span>
    <span class="d-none d-lg-block">
      <img class="img-fluid img-profile rounded-circle mx-auto mb-2" src="/img/profile.png" alt="">
    </span>
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link js-scroll-trigger" href="/#about">About</a>
      </li>
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#skills">Skills</a>
          </li>
      
      
      
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#experience">Experience</a>
          </li>
      
      
      
          <li class="nav-item">
            <a class="nav-link js-scroll-trigger" href="/#blog">Blog</a>
          </li>
      
    </ul>
  </div>
</nav>

  <div class="container-fluid p-0">
    
<nav aria-label="breadcrumb">
  <ol  class="breadcrumb">
    





<li class="breadcrumb-item">
  <a href="https://h-neco.github.io/">Home</a>
</li>


<li class="breadcrumb-item">
  <a href="https://h-neco.github.io/blog/">Blog</a>
</li>


<li class="breadcrumb-item active">
  <a href="https://h-neco.github.io/blog/aws-codebuild/">codebuild構築とdeployフローの整備</a>
</li>

  </ol>
</nav>




<section class="resume-section p-3 p-lg-5 d-flex flex-column">
  <div class="my-auto">
  	<div class="mb-3 d-flex flex-row justify-content-between">
    	<h2 class="mb-0"><span class="text-primary">codebuild構築とdeployフローの整備</span></h2>
    	<span class="">June 27, 2023</span>
    </div>
    <div>
    	<h3 id="はじめに">はじめに</h3>
<p>BitBucketPipelines で image の push を行っていましたが、cpu がマルチプラットフォームに対応しておらず、x86_64 のみしか対応していないため、イメージの push を CodeBuild で行うことにしました。
arm64 で ECS タスクを実行するとコストが 20％落ち、使い方によってはパフォーマンスが向上するらしい。</p>
<ul>
<li>今まで
<ul>
<li>[BitBucketPipelines]　 → 　[awsECR]</li>
</ul>
</li>
<li>変更後
<ul>
<li>[BitBucketPipelines]　 → 　[awsCodeBuild]　 → 　[awsECR]</li>
</ul>
</li>
</ul>
<h3 id="結果">結果</h3>
<p>コストが 20%ぐらい落ちた。パフォーマンスはまだサービスインしてないため分からない</p>
<h3 id="やること">やること</h3>
<ul>
<li>CodeBuild の設定
<ul>
<li>構成
<ul>
<li>/image/以下の Dockerfile を build して ECR に push する</li>
<li>/image/以下に buildspec.yml を配置</li>
</ul>
</li>
</ul>
</li>
<li>Bitbucket から CodeBuild を実行するための script 用意</li>
<li>bitbuket-pipelines.yml の修正</li>
</ul>
<h3 id="codebuild-の設定">CodeBuild の設定</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-hcl" data-lang="hcl"><span style="display:flex;"><span><span style="color:#66d9ef">data</span> <span style="color:#e6db74">&#34;aws_region&#34; &#34;this&#34;</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_codebuild_project&#34; &#34;ecr&#34;</span> {
</span></span><span style="display:flex;"><span>  badge_enabled          <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>  build_timeout          <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span> <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#ae81ff">20</span><span style="color:#960050;background-color:#1e0010">分</span>
</span></span><span style="display:flex;"><span>  concurrent_build_limit <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>  <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">並列実行数</span>
</span></span><span style="display:flex;"><span>  encryption_key         <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;arn:aws:kms:${data.aws_region.this.name}:${data.aws_caller_identity.self.account_id}:alias/aws/s3&#34;</span>
</span></span><span style="display:flex;"><span>  name                   <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ecr-build-${terraform.workspace}&#34;</span>
</span></span><span style="display:flex;"><span>  project_visibility     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PRIVATE&#34;</span>
</span></span><span style="display:flex;"><span>  queued_timeout         <span style="color:#f92672">=</span> <span style="color:#ae81ff">480</span>
</span></span><span style="display:flex;"><span>  service_role           <span style="color:#f92672">=</span> <span style="color:#66d9ef">aws_iam_role</span>.<span style="color:#66d9ef">codebuild_role</span>.<span style="color:#66d9ef">arn</span>
</span></span><span style="display:flex;"><span>  tags <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    Environment  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;${terraform.workspace}&#34;</span>
</span></span><span style="display:flex;"><span>    Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ecr-build-${terraform.workspace}&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">environment</span> {
</span></span><span style="display:flex;"><span>    compute_type                <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;BUILD_GENERAL1_SMALL&#34;</span> <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">vCPU</span>, <span style="color:#ae81ff">3</span>.<span style="color:#ae81ff">75</span><span style="color:#960050;background-color:#1e0010">GB</span>
</span></span><span style="display:flex;"><span>    image                       <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;aws/codebuild/amazonlinux2-aarch64-standard:3.0&#34;</span>
</span></span><span style="display:flex;"><span>    type                        <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ARM_CONTAINER&#34;</span>
</span></span><span style="display:flex;"><span>    image_pull_credentials_type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;CODEBUILD&#34;</span>
</span></span><span style="display:flex;"><span>    privileged_mode             <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> <span style="color:#960050;background-color:#1e0010">//</span> <span style="color:#960050;background-color:#1e0010">dockerコマンドを叩く場合は必須</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">artifacts</span> {
</span></span><span style="display:flex;"><span>    type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NO_ARTIFACTS&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">source</span> {
</span></span><span style="display:flex;"><span>    location            <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bucketname/buildspec/&#34;</span>
</span></span><span style="display:flex;"><span>    buildspec           <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;codebuild/${terraform.workspace}/buildspec.yml&#34;</span>
</span></span><span style="display:flex;"><span>    report_build_status <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    type                <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;S3&#34;</span>
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#------------------------------------------------------------#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># code build role
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#------------------------------------------------------------#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">data</span> <span style="color:#e6db74">&#34;aws_iam_policy_document&#34; &#34;codebuild_role&#34;</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">statement</span> {
</span></span><span style="display:flex;"><span>    sid     <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>    effect  <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Allow&#34;</span>
</span></span><span style="display:flex;"><span>    actions <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;sts:AssumeRole&#34;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">principals</span> {
</span></span><span style="display:flex;"><span>      type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Service&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      identifiers <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;codebuild.amazonaws.com&#34;</span>
</span></span><span style="display:flex;"><span>      ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_iam_role&#34; &#34;codebuild_role&#34;</span> {
</span></span><span style="display:flex;"><span>  name               <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;codebuild-ecr-build-${terraform.workspace}&#34;</span>
</span></span><span style="display:flex;"><span>  assume_role_policy <span style="color:#f92672">=</span> <span style="color:#66d9ef">data</span>.<span style="color:#66d9ef">aws_iam_policy_document</span>.<span style="color:#66d9ef">codebuild_role</span>.<span style="color:#66d9ef">json</span>
</span></span><span style="display:flex;"><span>}<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#------------------------------------------------------------#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># code build atached policy s3 access
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#------------------------------------------------------------#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_iam_policy&#34; &#34;codebuild_s3_access_policy&#34;</span> {
</span></span><span style="display:flex;"><span>  name        <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;codebuild-s3-access-policy-${terraform.workspace}&#34;</span>
</span></span><span style="display:flex;"><span>  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;codebuild_s3_access_policy&#34;</span>
</span></span><span style="display:flex;"><span>  policy      <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&lt;&lt;</span><span style="color:#66d9ef">EOT</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Version&#34;: &#34;2012-10-17&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Statement&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Effect&#34;: &#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Action&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;s3:GetObject&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;s3:GetObjectVersion&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Resource&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;arn:aws:s3:::bucketname/buildspec/&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;arn:aws:s3:::bucketname/buildspec/*&#34;</span>
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Effect&#34;: &#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Resource&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;arn:aws:s3:::bucketname&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Action&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;s3:ListBucket&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;s3:GetBucketAcl&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;s3:GetBucketLocation&#34;</span>
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EOT</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_iam_role_policy_attachment&#34; &#34;codebuild_s3_access_policy&#34;</span> {
</span></span><span style="display:flex;"><span>  role       <span style="color:#f92672">=</span> <span style="color:#66d9ef">aws_iam_role</span>.<span style="color:#66d9ef">codebuild_role</span>.<span style="color:#66d9ef">name</span>
</span></span><span style="display:flex;"><span>  policy_arn <span style="color:#f92672">=</span> <span style="color:#66d9ef">aws_iam_policy</span>.<span style="color:#66d9ef">codebuild_s3_access_policy</span>.<span style="color:#66d9ef">arn</span>
</span></span><span style="display:flex;"><span>}<span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#------------------------------------------------------------#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># code build atached ecr push policy
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#------------------------------------------------------------#
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_iam_policy&#34; &#34;codebuild_ecr_push_policy&#34;</span> {
</span></span><span style="display:flex;"><span>  name        <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;codebuild-ecr-push-policy-${terraform.workspace}&#34;</span>
</span></span><span style="display:flex;"><span>  description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;codebuild_ecr_push_policy&#34;</span>
</span></span><span style="display:flex;"><span>  policy      <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">&lt;&lt;</span><span style="color:#66d9ef">EOT</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Version&#34;: &#34;2012-10-17&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;Statement&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Sid&#34;: &#34;ecr&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Effect&#34;: &#34;Allow&#34;</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Action&#34;</span><span style="color:#960050;background-color:#1e0010">:</span> [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ecr:BatchCheckLayerAvailability&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ecr:CompleteLayerUpload&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ecr:GetAuthorizationToken&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ecr:InitiateLayerUpload&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ecr:PutImage&#34;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#34;ecr:UploadLayerPart&#34;</span>
</span></span><span style="display:flex;"><span>            ],
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Resource&#34;: &#34;*&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">EOT</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">resource</span> <span style="color:#e6db74">&#34;aws_iam_role_policy_attachment&#34; &#34;codebuild_ecr_push_policy&#34;</span> {
</span></span><span style="display:flex;"><span>  role       <span style="color:#f92672">=</span> <span style="color:#66d9ef">aws_iam_role</span>.<span style="color:#66d9ef">codebuild_role</span>.<span style="color:#66d9ef">name</span>
</span></span><span style="display:flex;"><span>  policy_arn <span style="color:#f92672">=</span> <span style="color:#66d9ef">aws_iam_policy</span>.<span style="color:#66d9ef">codebuild_ecr_push_policy</span>.<span style="color:#66d9ef">arn</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="buildspec-yal-の配置">buildspec yal の配置</h3>
<ul>
<li>この辺を参考にして作成して配置
<ul>
<li><a href="https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/sample-docker.html">https://docs.aws.amazon.com/ja_jp/codebuild/latest/userguide/sample-docker.html</a></li>
</ul>
</li>
</ul>
<h3 id="bitbucket-から-codebuild-を実行する用のスクリプト">BitBucket から codebuild を実行する用のスクリプト</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>env<span style="color:#f92672">=</span>$1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># codebuildの実行結果を取得する</span>
</span></span><span style="display:flex;"><span>build_output<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws codebuild start-build --project-name nnslink-ecr-build-<span style="color:#e6db74">${</span>env<span style="color:#e6db74">}</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>build_id<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>echo <span style="color:#e6db74">&#34;</span>$build_output<span style="color:#e6db74">&#34;</span> | jq -r <span style="color:#e6db74">&#39;.build.id&#39;</span><span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>count<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">while</span> : ; <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># codebuildの状態を取得する</span>
</span></span><span style="display:flex;"><span>    build_status<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>aws codebuild batch-get-builds --ids $build_id --query <span style="color:#e6db74">&#39;builds[0].[buildStatus]&#39;</span> --output text<span style="color:#66d9ef">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$build_status<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SUCCEEDED&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;done!&#34;</span>
</span></span><span style="display:flex;"><span>        break
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">elif</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$build_status<span style="color:#e6db74">&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;FAILED&#34;</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 10分以上かかったら失敗扱いで終了</span>
</span></span><span style="display:flex;"><span>    count<span style="color:#f92672">=</span><span style="color:#66d9ef">$((</span>count+1<span style="color:#66d9ef">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> $count -gt <span style="color:#ae81ff">20</span> <span style="color:#f92672">]</span>; <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>        echo <span style="color:#e6db74">&#34;[timeout] check aws codebuild console for more detail.&#34;</span>
</span></span><span style="display:flex;"><span>        exit <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">fi</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;prosessing...&#34;</span>
</span></span><span style="display:flex;"><span>    sleep <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">done</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exit <span style="color:#ae81ff">0</span>
</span></span></code></pre></div><h3 id="bitbucketpipeline-の設定">BitbucketPipeline の設定</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">definitions</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">steps</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">step</span>: <span style="color:#75715e">&amp;ECR-push</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ECR push</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">image</span>: <span style="color:#ae81ff">atlassian/pipelines-awscli:latest</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">trigger</span>: <span style="color:#ae81ff">manual</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">oidc</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">script</span>:
</span></span><span style="display:flex;"><span>                  - <span style="color:#ae81ff">export AWS_WEB_IDENTITY_TOKEN_FILE=$(pwd)/web-identity-token</span>
</span></span><span style="display:flex;"><span>                  - <span style="color:#ae81ff">echo $BITBUCKET_STEP_OIDC_TOKEN &gt; $(pwd)/web-identity-token</span>
</span></span><span style="display:flex;"><span>                  - <span style="color:#ae81ff">aws s3 sync ${BITBUCKET_CLONE_DIR}/image/ s3://bucketname/buildspec/ --delete</span>
</span></span><span style="display:flex;"><span>                  - <span style="color:#ae81ff">/bin/bash ./scripts/codebuild.sh ${ENV}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">pipelines</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">custom</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image-update</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">step</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">&lt;&lt;</span>: <span style="color:#75715e">*ECR-push</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">deployment</span>: <span style="color:#ae81ff">Staging</span>
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">step</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">&lt;&lt;</span>: <span style="color:#75715e">*ECR-push</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">deployment</span>: <span style="color:#ae81ff">Production</span>
</span></span></code></pre></div>
	    
	</div>
    <div>
    	
    </div>
    <ul class="tags">
    
</ul>

  </div>
</section>

    <section><span style="color: #999999;">Nifty <a href="https://codepen.io/wbeeftink/pen/dIaDH">tech tag lists</a> from <a class="pen-owner-link" href="https://codepen.io/wbeeftink">Wouter Beeftink</a> </span>
      
    </section>
  </div>
  
  <script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

  
  <script async src="https://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.4.1/jquery.easing.min.js" integrity="sha512-0QbL0ph8Tc8g5bLhfVzSqxe9GERORsKhIn1IrpxDAgUsbBGz/V7iSav2zzW325XGd1OMLdL4UiqRJj702IeqnQ==" crossorigin="anonymous"></script>
  
  <script async src="/js/resume.js"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-Z6BYZ5M6VX"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-Z6BYZ5M6VX');
  </script>
  

  
</body>
</html>
