<!doctype html><html dir="ltr" lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>AmazonLinux2で作るNATインスタンス(Packer|Ansible) &#183; n's tech blog</title><meta name="title" content="AmazonLinux2で作るNATインスタンス(Packer|Ansible) &#183; n's tech blog"><meta name="description" content="amazonLinux2でNATインスタンスを構築してみました。Packer,Ansibleを利用しています。"><link rel="canonical" href="/posts/ec2-nat-instance/"><link type="text/css" rel="stylesheet" href="/css/main.min.e2435bff3a90fa0016b5695f40ff2aea931364daf08807580d4abebbec12aff7.css" integrity="sha256-4kNb/zqQ+gAWtWlfQP8q6pMTZNrwiAdYDUq+u+wSr/c="><link rel="icon" sizes="192x192" href="/logo-192.png"><link rel="apple-touch-icon" href="/logo-192.png"><link rel="mask-icon" href="/logo.svg" color="blue"><link rel="manifest" href="/site.webmanifest"><meta property="og:title" content="AmazonLinux2で作るNATインスタンス(Packer|Ansible)"><meta property="og:description" content="amazonLinux2でNATインスタンスを構築してみました。Packer,Ansibleを利用しています。"><meta property="og:type" content="article"><meta property="og:url" content="/posts/ec2-nat-instance/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-11T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-11T00:00:00+00:00"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="AmazonLinux2で作るNATインスタンス(Packer|Ansible)"><meta name="twitter:description" content="amazonLinux2でNATインスタンスを構築してみました。Packer,Ansibleを利用しています。"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","articleSection":"Posts","name":"AmazonLinux2で作るNATインスタンス(Packer|Ansible)","headline":"AmazonLinux2で作るNATインスタンス(Packer|Ansible)","description":"amazonLinux2でNATインスタンスを構築してみました。Packer,Ansibleを利用しています。","author":{"@type":"Person","name":"Hi"},"creator":{"@type":"Person","name":"Hi"},"copyrightHolder":"Hi","copyrightYear":"2023","dateCreated":"2023-03-11T00:00:00\u002b00:00","datePublished":"2023-03-11T00:00:00\u002b00:00","dateModified":"2023-03-11T00:00:00\u002b00:00","url":"\/posts\/ec2-nat-instance\/","wordCount":"428","keywords":["nat","ec2","packer","ansible"]}</script><meta name="generator" content="Hugo 0.111.3"><meta name="author" content="n's"><script defer src="/js/main.min.3bfc9774c933123803ba09c8b89eeda9822dd63321db002f0bfd9cdc3129b0fa.js" integrity="sha256-O/yXdMkzEjgDugnIuJ7tqYIt1jMh2wAvC/2c3DEpsPo="></script>
<script>"theme"in localStorage||(localStorage.theme="auto"),(localStorage.theme==="dark"||(!("theme"in localStorage)||localStorage.theme==="auto")&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.documentElement.classList.add("dark")</script></head><body class="w-full min-h-full" x-data="{ up: false }"><div x-data="{ open: false }" @keydown.window.escape="open = false" class="sticky inset-x-0 top-0 z-10"><div class="fixed z-10 flex w-48 h-screen lg:hidden" :class="open ? '' : 'hidden'" x-ref="dialog" aria-modal="true"><div class="fixed inset-0 bg-black bg-opacity-25" :class="open ? '' : 'hidden'" x-transition:enter="transition-opacity ease-linear duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition-opacity ease-linear duration-300" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" x-description="Off-canvas menu overlay, show/hide based on off-canvas menu state." @click="open = false" aria-hidden="true"></div><div class="fixed inset-0 flex flex-col w-full h-full pb-12 overflow-y-auto shadow-xl bg-neutral-50 text-neutral-900 dark:bg-neutral-800 dark:text-neutral-200 max-w-xxs" :class="open ? '' : 'hidden'" x-transition:enter="transition ease-in-out duration-300" x-transition:enter-start="-translate-x-full" x-transition:enter-end="translate-x-0" x-transition:leave="transition ease-in-out duration-300" x-transition:leave-start="translate-x-0" x-transition:leave-end="-translate-x-full" x-description="Off-canvas menu, show/hide based on off-canvas menu state."><div class="flex px-4 pt-5 pb-2"><button type="button" title="Close menu" class="inline-flex items-center justify-center p-2 -m-2 rounded-md text-neutral-400" @click="open = false">
<span class="sr-only">Close menu</span><svg class="w-6 h-6" x-description="Heroicon name: outline/x" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 18 6M6 6l12 12"/></svg></button></div><ul class="py-4 divide-y divide-neutral-200"><li class="flow-root px-4 py-2"><a href="/" title="n's tech blog" class="block p-2 -m-2 font-medium">Home</a></li><li class="flow-root px-4 py-2
bg-neutral-200 dark:bg-neutral-900"><a href="/posts/" title="Posts" class="block p-2 -m-2 font-medium">Blog</a></li><li class="flow-root px-4 py-2"><a href="/tags/" title="Tags" class="block p-2 -m-2 font-medium">Tags</a></li><li class="flow-root px-4 py-2"><a href="https://github.com/H-Neco" title class="block p-2 -m-2 font-medium">GitHub</a></li></ul></div></div><header class="shadow dark:shadow-dark bg-neutral-50 text-neutral-900 dark:bg-neutral-800 dark:text-neutral-200"><nav class="container flex leading-12 items-center px-6 mx-auto max-w-7xl lg:px-8 xl:px-12 bg-neutral-50 text-neutral-900 dark:bg-neutral-800 dark:text-neutral-200" aria-label="Top"><a class="relative hidden p-2 align-middle lg:block" rel="me" href="/" title="n's tech blog"><img src="/logo-192.png" class="h-8 w-auto" alt="n's tech blog"></a>
<button class="lg:hidden" type="button" @click="open = true" aria-label="Open menu"><svg class="block w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentcolor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg></button><div class="flex-grow h-12 mx-2"><div class="relative w-full h-full"><div class="absolute max-w-full" :class="up ? 'hidden' : ''" x-transition.duration.500ms><span class="font-semibold overflow-hidden text-ellipsis whitespace-nowrap">n's tech blog</span></div><template x-if="true"><div class="absolute top-0 left-0 right-0 max-w-full" :class="up ? '' : 'hidden'" x-transition.duration.500ms><span class="overflow-hidden text-ellipsis whitespace-nowrap">AmazonLinux2で作るNATインスタンス(Packer|Ansible)</span></div></template></div></div><ul class="shrink hidden ml-7 lg:flex flex-row justify-end list-none"><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500"><a href="/" title="n's tech blog">Home</a></li><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500
border-primary-500"><a href="/posts/" title="Posts">Blog</a></li><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500"><a href="/tags/" title="Tags">Tags</a></li><li class="border-b-2 border-transparent text-right mr-7 hover:border-primary-500"><a href="https://github.com/H-Neco" title>GitHub</a></li></ul><button id="switchTheme" class="w-8 h-8 flex justify-center items-center focus:outline-none">
<span class="sr-only">Switch theme</span><svg class="w-5 h-5" fill="currentcolor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1A1 1 0 119 4V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707A1 1 0 1113.536 5.05l.707-.707a1 1 0 011.414.0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707A1 1 0 004.343 5.757l.707.707zm1.414 8.486-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"/></svg>
<span class="light"></span><span class="dark"></span></button>
<script>document.getElementById("switchTheme").addEventListener("click",function(){localStorage.theme==="dark"||(!("theme"in localStorage)||localStorage.theme==="auto")&&window.matchMedia("(prefers-color-scheme: dark)").matches?(document.documentElement.classList.remove("dark"),localStorage.theme="light"):(localStorage.theme==="light"||(!("theme"in localStorage)||localStorage.theme==="auto")&&window.matchMedia("(prefers-color-scheme: light)").matches)&&(document.documentElement.classList.add("dark"),localStorage.theme="dark")})</script></nav></header></div><main class="container flex flex-row px-6 mx-auto my-6 lg:px-8 xl:px-12 max-w-7xl"><article class="flex-grow mx-auto text-lg lg:text-xl min-w-0 max-w-prose"><header class="text-base"><ol class="pb-4 text-sm text-neutral-500 dark:text-neutral-400"><li class="inline hidden"><a class="hover:underline" href="/">n's tech blog</a><span class="px-1 text-primary-500">/</span></li><li class="inline"><a class="hover:underline" href="/posts/">Posts</a><span class="px-1 text-primary-500">/</span></li><li class="inline hidden"><a class="hover:underline" href="/posts/ec2-nat-instance/">AmazonLinux2で作るNATインスタンス(Packer|Ansible)</a><span class="px-1 text-primary-500">/</span></li></ol><h1 class="my-3 text-3xl font-semibold text-neutral-800 dark:text-neutral-200" x-intersect:enter="up = false" x-intersect:leave="up = true">AmazonLinux2で作るNATインスタンス(Packer|Ansible)</h1><div class="mb-6 text-base text-neutral-500 dark:text-neutral-400"><div class="flex flex-row items-center"><time datetime="2023-03-11 00:00:00 +0000 UTC">11 March 2023</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">3 mins</span><span class="px-2 text-primary-500">&#183;</span>
<span class="mb-[2px]"><a href="https://github.com/canstand/compost/tree/main/exampleSite/content/posts/ec2-nat-instance.md" class="text-lg hover:text-primary-500" rel="noopener noreferrer" target="_blank" title="Edit content"><span class="relative inline-block align-text-bottom icon"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentcolor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6A2 2 0 004 7v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg></span></a></span></div></div></header><section class="max-w-none text-base prose dark:prose-invert"><h2 id="やること">やること <a class="heading-anchor" href="#%e3%82%84%e3%82%8b%e3%81%93%e3%81%a8" aria-hidden="true">#</a></h2><ul><li>amazonLinux2でNATインスタンスを構築する</li><li>なぜamazonLinux2なのか<ul><li>Lambdaは外部から開始する通信を受け付けられないため、ActiveモードでのFTPはサポートされていません。</li><li>ECSはPrivateIPの固定化ができませんでした。<ul><li>NATPrivateGWと組み合わせることで固定化はできるが、ゲートウェイタイプなので外部から開始する通信を受付できません。</li></ul></li></ul></li></ul><h2 id="技術要素">技術要素 <a class="heading-anchor" href="#%e6%8a%80%e8%a1%93%e8%a6%81%e7%b4%a0" aria-hidden="true">#</a></h2><ul><li>Packer</li><li>ansible</li><li>iptable<ul><li>CentOS7(amazonLinux2)では、firewalldというファイアウォール管理システムがデフォルトで採用されていますが、iptablesを導入してNATインスタンスを構築します。</li></ul></li></ul><h2 id="ファイル構成">ファイル構成 <a class="heading-anchor" href="#%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e6%a7%8b%e6%88%90" aria-hidden="true">#</a></h2><pre tabindex="0"><code>$ tree .
.
├── ansible.cfg
├── bin
│   └── init.sh
├── inventory
│   └── hosts
├── packer-template
│   └── nat_instance.json
├── playbook
│   └── setup.yml
└── roles
    └── iptable
        └── tasks
            ├── main.yml
            └── templates
                ├── iptables-config.j2
                ├── nat_cidr.j2
                └── sysctl.conf
</code></pre><h2 id="packerの実行とテンプレートファイル">Packerの実行とテンプレートファイル <a class="heading-anchor" href="#packer%e3%81%ae%e5%ae%9f%e8%a1%8c%e3%81%a8%e3%83%86%e3%83%b3%e3%83%97%e3%83%ac%e3%83%bc%e3%83%88%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab" aria-hidden="true">#</a></h2><ul><li>実行コマンド<ul><li>packer build packer-template/nat_instance.json</li></ul></li></ul><pre tabindex="0"><code>.
└── packer-template
   └── nat_instance.json
</code></pre><pre tabindex="0"><code>{
    &#34;variables&#34;: {
        &#34;aws_access_key&#34;: &#34;{{env `AWS_ACCESS_KEY`}}&#34;,
        &#34;aws_secret_key&#34;: &#34;{{env `AWS_SECRET_KEY`}}&#34;
    },
    &#34;builders&#34;: [
        {
            &#34;type&#34;: &#34;amazon-ebs&#34;,
            &#34;access_key&#34;: &#34;{{user `aws_access_key`}}&#34;,
            &#34;secret_key&#34;: &#34;{{user `aws_secret_key`}}&#34;,
            &#34;region&#34;: &#34;ap-northeast-1&#34;,
            &#34;ami_regions&#34;: [
                &#34;ap-northeast-1&#34;
            ],
            &#34;associate_public_ip_address&#34;: true,
            &#34;source_ami&#34;: &#34;ami-0a3d21ec6281df8cb&#34;,
            &#34;instance_type&#34;: &#34;t3.micro&#34;,
            &#34;ssh_username&#34;: &#34;ec2-user&#34;,
            &#34;ami_name&#34;: &#34;nat-{{timestamp}}&#34;,
            &#34;tags&#34;: {
                &#34;Name&#34;: &#34;nat-instance&#34;
            },
            &#34;ena_support&#34;: true,
            &#34;enable_t2_unlimited&#34;: false
        }
    ],
    &#34;provisioners&#34;: [
    {
      &#34;type&#34;: &#34;shell&#34;,
      &#34;script&#34;: &#34;./bin/init.sh&#34;,
      &#34;pause_before&#34;: &#34;60s&#34;
    },
    {
      &#34;type&#34;: &#34;ansible-local&#34;,
        &#34;inventory_file&#34;: &#34;inventory/hosts&#34;,
        &#34;playbook_file&#34;: &#34;playbook/setup.yml&#34;,
        &#34;role_paths&#34;: [
                &#34;roles/iptable&#34;
            ],
        &#34;staging_directory&#34;: &#34;/tmp/ansible-local&#34;,
        &#34;extra_arguments&#34;: [&#34;-vv&#34;]
    }]
}
</code></pre><h2 id="ansibleの準備">ansibleの準備 <a class="heading-anchor" href="#ansible%e3%81%ae%e6%ba%96%e5%82%99" aria-hidden="true">#</a></h2><ul><li>ファイル</li></ul><pre tabindex="0"><code>.
├── ansible.cfg
├── bin
│   └── init.sh
└── inventory
   └── hosts
</code></pre><h3 id="ansibleの導入">ansibleの導入 <a class="heading-anchor" href="#ansible%e3%81%ae%e5%b0%8e%e5%85%a5" aria-hidden="true">#</a></h3><p><code>./bin/init.sh</code>でansibleの導入を行います</p><pre tabindex="0"><code>#!/bin/bash
sudo yum -y update
# ansible 導入
amazon-linux-extras install epel
amazon-linux-extras enable ansible2
amazon-linux-extras install ansible2
</code></pre><h3 id="インベントリファイルの配置">インベントリファイルの配置 <a class="heading-anchor" href="#%e3%82%a4%e3%83%b3%e3%83%99%e3%83%b3%e3%83%88%e3%83%aa%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%ae%e9%85%8d%e7%bd%ae" aria-hidden="true">#</a></h3><p><code>inventory/hosts</code>ファイルの配置</p><p>今回は立てるサーバーからローカルにansibleを実行するため、localをターゲットに指定します。</p><pre tabindex="0"><code>[default]
127.0.0.1
</code></pre><h3 id="設定ファイルの配置">設定ファイルの配置 <a class="heading-anchor" href="#%e8%a8%ad%e5%ae%9a%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%ae%e9%85%8d%e7%bd%ae" aria-hidden="true">#</a></h3><p><code>ansible.cfg</code>ファイルの配置</p><p>ansibleを実行するための</p><pre tabindex="0"><code>[defaults]

# Pythonインタプリタを指定
interpreter_python=/usr/bin/python3
# hostsファイルの場所
inventory = inventroy/hosts
# 接続するときにホスト公開鍵の検証をするかしないか
host_key_checking = True
# リモード接続するときに平行して生成するプロセス数
forks=5
# ログファイルのパス
log_path=~/logs/ansible/ansible.log
# 色の設定
nocolor=0
scp_if_ssh=True
</code></pre><h2 id="ansible-playbookの作成">ansible playbookの作成 <a class="heading-anchor" href="#ansible-playbook%e3%81%ae%e4%bd%9c%e6%88%90" aria-hidden="true">#</a></h2><ul><li>ファイル</li></ul><pre tabindex="0"><code>.
├── playbook
│   └── setup.yml
└── roles
    └── iptable
        └── tasks
            ├── main.yml
            └── templates
                ├── iptables-config.j2
                ├── nat_cidr.j2
                └── sysctl.conf
</code></pre><p>packerで呼び出される<code>playbook/setup.yml</code>を記述していきます。
iptableロールを呼び出し、ルーティングの後に実行される送信時に送信元アドレス/ポートを変換するチェインを引数に指定します。</p><pre tabindex="0"><code>---
- hosts: all
  become: yes
  become_user: root
  remote_user: ec2-user
  roles:
    - role: iptable
      vars:
        nat_cidr: 10.0.0.1/24
</code></pre><p>playbookで呼び出されるiptableロールのmain.ymlを記述していきます。
処理の大枠は、iptablesの導入とコンフィグファイルの配置です。</p><ul><li>roles/iptable/tasks/main.yml</li></ul><pre tabindex="0"><code>---
- name: Install iptables-service
  yum: name=iptables-services state=latest

- name: Enable port forwarding
  template: src=&#34;sysctl.conf&#34; dest=&#34;/etc/sysctl.conf&#34; owner=root group=root mode=0644

# IP tables
- name: Make iptables file
  template: src=&#34;{{ item }}.j2&#34; dest=&#34;/etc/sysconfig/{{ item }}&#34; owner=root group=root mode=0600
  with_items:
    - &#34;nat_cidr&#34;

# IP tables config
- name: Make iptables-config file
  template: src=&#34;iptables-config.j2&#34; dest=&#34;/etc/sysconfig/iptables-config-nat&#34; owner=root group=root mode=0600

- name: Install ftp command
  yum: name=ftp state=latest

- name: Install tcpdump command
  yum: name=tcpdump state=latest

- name: Install lftp command
  yum: name=lftp state=latest
</code></pre><ul><li>上記で使われているテンプレートファイルを記述していきます<ul><li>roles/iptable/tasks/templates/iptables-config.j2</li><li>roles/iptable/tasks/templates/sysctl.conf</li><li>roles/iptable/tasks/templates/nat_cidr.j2</li></ul></li></ul><p><code>roles/iptable/tasks/templates/iptables-config.j2</code></p><pre tabindex="0"><code>IPTABLES_MODULES=&#34;nf_conntrack_ftp nf_nat_ftp&#34;
IPTABLES_MODULES_UNLOAD=&#34;yes&#34;
IPTABLES_SAVE_ON_STOP=&#34;no&#34;
IPTABLES_SAVE_ON_RESTART=&#34;no&#34;
IPTABLES_SAVE_COUNTER=&#34;no&#34;
IPTABLES_STATUS_NUMERIC=&#34;yes&#34;
IPTABLES_STATUS_VERBOSE=&#34;no&#34;
IPTABLES_STATUS_LINENUMBERS=&#34;yes&#34;
</code></pre><p><code>roles/iptable/tasks/templates/sysctl.conf</code></p><p>IPv4転送と呼ばれる機能を有効にするために「/proc/sys/net/ipv4/ip_forward」ファイルの内容を「1」にします。</p><pre tabindex="0"><code>net.ipv4.ip_forward=1
</code></pre><p><code>roles/iptable/tasks/templates/nat_cidr.j2</code></p><pre tabindex="0"><code>*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
COMMIT
*nat
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -s {{ nat_cidr }} -j MASQUERADE
COMMIT
*raw
:PREROUTING ACCEPT [0:0]
-A PREROUTING -p tcp --dport 21 -j CT --helper ftp
COMMIT
</code></pre><h2 id="ec2のネットワーク設定">EC2のネットワーク設定 <a class="heading-anchor" href="#ec2%e3%81%ae%e3%83%8d%e3%83%83%e3%83%88%e3%83%af%e3%83%bc%e3%82%af%e8%a8%ad%e5%ae%9a" aria-hidden="true">#</a></h2><p>インスタンスでNATインスタンスのENIの送信先チェックの無効化を実施します。</p><pre tabindex="0"><code>aws ec2 modify-instance-attribute \
  --no-source-dest-check \
  --instance-id ${INSTANCE_ID}
</code></pre><h2 id="サーバーに接続しiptablesを起動">サーバーに接続しiptablesを起動 <a class="heading-anchor" href="#%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc%e3%81%ab%e6%8e%a5%e7%b6%9a%e3%81%97iptables%e3%82%92%e8%b5%b7%e5%8b%95" aria-hidden="true">#</a></h2><p>設定ファイルを配置とiptablesをリスタートする</p><pre tabindex="0"><code># ansibleで配布したファイルで設定ファイルを上書きする
sudo cp /etc/sysconfig/iptables-config-nat /etc/sysconfig/iptables
# 設定の永続化
sudo service iptables save
# サービスの再起動
sudo systemctl restart iptables
</code></pre></section><footer class="pt-8"><div class="flex text-base text-neutral-500 dark:text-neutral-400"><img class="w-16 h-16 my-auto mr-4 rounded-full" src="/img/author.jpg" alt="Avatar"><div class="place-self-center"><div class="text-xs uppercase" aria-hidden="true">Author</div><div class="my-1 font-bold text-neutral-800 dark:text-neutral-300">n&rsquo;s</div></div></div><div class="article-pagination"><hr><div><span><a class="flex text-right" href="/posts/ec2-ebs-delete-on-termination/"><span class="mr-3 article-pagination-direction">&larr;</span>
<span class="flex flex-col"><span class="article-pagination-title">EC2にアタッチされたEBSを永続化する</span>
<span class="article-pagination-date"><time datetime="2023-03-11 00:00:00 +0000 UTC">11 March 2023</time></span></span></a></span>
<span></span></div></div></footer></article><aside class="flex-auto min-w-0 space-y-6 pl-10 mt-3 pr-4 xl:pl-16 hidden lg:block text-sm xl:text-base"><div><label class="font-bold text-lg">Tags</label><div class="space-x-2 mt-2"><a href="/tags/nat/" class="hover:underline">#nat</a>
<a href="/tags/ec2/" class="hover:underline">#ec2</a>
<a href="/tags/packer/" class="hover:underline">#packer</a>
<a href="/tags/ansible/" class="hover:underline">#ansible</a></div></div><div class="sticky self-start top-20 min-h-screen overflow-y-auto truncate"><label class="font-bold text-lg mb-4">Table of contents</label><nav id="TableOfContents"><ul><li><a href="#やること">やること</a></li><li><a href="#技術要素">技術要素</a></li><li><a href="#ファイル構成">ファイル構成</a></li><li><a href="#packerの実行とテンプレートファイル">Packerの実行とテンプレートファイル</a></li><li><a href="#ansibleの準備">ansibleの準備</a><ul><li><a href="#ansibleの導入">ansibleの導入</a></li><li><a href="#インベントリファイルの配置">インベントリファイルの配置</a></li><li><a href="#設定ファイルの配置">設定ファイルの配置</a></li></ul></li><li><a href="#ansible-playbookの作成">ansible playbookの作成</a></li><li><a href="#ec2のネットワーク設定">EC2のネットワーク設定</a></li><li><a href="#サーバーに接続しiptablesを起動">サーバーに接続しiptablesを起動</a></li></ul></nav></div></aside><script>window.addEventListener("DOMContentLoaded",()=>{const t=new IntersectionObserver(e=>{e.forEach(e=>{const n=e.target.getAttribute("id"),t=document.querySelector(`nav li a[href="#${n}"]`);t!==null&&(e.intersectionRatio>0?t.parentElement.classList.add("active"):t.parentElement.classList.remove("active"))})}),e=[];for(let t=1;t<=6;t++)e.push(`article h${t}[id]`);document.querySelectorAll(e.join()).forEach(e=>{t.observe(e)})})</script></main><footer class="text-neutral-500 dark:text-neutral-500 bg-neutral-200 dark:bg-neutral-900"><div class="container flex flex-row px-6 lg:px-8 xl:px-12 py-4 mx-auto text-sm max-w-7xl"><div class="flex-1"><p>&copy;
2023
n's</p><p class="text-sm">Powered by <a class="hover:underline hover:text-primary-500" href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:text-primary-500" href="https://canstand.github.io/compost" target="_blank" rel="noopener noreferrer">Compost</a></p></div><div class="flex-1"></div></div></footer></body></html>